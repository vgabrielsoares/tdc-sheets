<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Changeset: Criação das tabelas de atributos do personagem -->
    <changeSet id="004-create-character-attributes-tables" author="tdc-sheets">
        <comment>Criação das tabelas para atributos e características do personagem</comment>
        
        <!-- Tabela de atributos do personagem -->
        <createTable tableName="atributos_personagem">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ficha_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="atributo" type="atributos">
                <constraints nullable="false"/>
            </column>
            <column name="valor" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="valor_temp" type="INTEGER"/>
            <column name="modificador" type="INTEGER"/>
            <column name="modificador_temp" type="INTEGER"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by_user_id" type="BIGINT"/>
            <column name="updated_by_user_id" type="BIGINT"/>
            <column name="is_active" type="BOOLEAN" defaultValue="true">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de resistências do personagem -->
        <createTable tableName="resistencias_personagem">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ficha_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="tipo_resistencia" type="tipos_resistencia">
                <constraints nullable="false"/>
            </column>
            <column name="valor" type="INTEGER"/>
            <column name="imune" type="BOOLEAN" defaultValue="false"/>
            <column name="vulneravel" type="BOOLEAN" defaultValue="false"/>
            <column name="resistente" type="BOOLEAN" defaultValue="false"/>
            <column name="absorcao" type="BOOLEAN" defaultValue="false"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de sentidos do personagem -->
        <createTable tableName="sentidos_personagem">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ficha_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="tipo_sentido" type="tipos_sentidos">
                <constraints nullable="false"/>
            </column>
            <column name="alcance" type="INTEGER"/>
            <column name="mod_visao" type="INTEGER"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de deslocamento do personagem -->
        <createTable tableName="deslocamento_personagem">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ficha_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="tipo_deslocamento" type="tipos_deslocamento">
                <constraints nullable="false"/>
            </column>
            <column name="valor" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="bonus" type="INTEGER"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de ações do personagem -->
        <createTable tableName="acoes_personagem">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ficha_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="tipo_acao" type="tempo_acoes">
                <constraints nullable="false"/>
            </column>
            <column name="quantidade" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="acao_disponivel" type="BOOLEAN" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de proficiências do personagem -->
        <createTable tableName="proficiencias_personagem">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ficha_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="tipo_proficiencia" type="tipos_proficiencia">
                <constraints nullable="false"/>
            </column>
            <column name="nome" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
            <column name="proficiente" type="BOOLEAN" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Índices para performance -->
        <createIndex tableName="atributos_personagem" indexName="idx_atributos_ficha">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <createIndex tableName="atributos_personagem" indexName="idx_atributos_tipo">
            <column name="atributo"/>
        </createIndex>
        
        <createIndex tableName="atributos_personagem" indexName="idx_atributos_ficha_tipo">
            <column name="ficha_personagem_id"/>
            <column name="atributo"/>
        </createIndex>
        
        <createIndex tableName="atributos_personagem" indexName="idx_atributos_active">
            <column name="is_active"/>
        </createIndex>
        
        <createIndex tableName="resistencias_personagem" indexName="idx_resistencias_ficha">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <createIndex tableName="sentidos_personagem" indexName="idx_sentidos_ficha">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <!-- Unique constraints -->
        <addUniqueConstraint tableName="atributos_personagem" columnNames="ficha_personagem_id, atributo" constraintName="uk_atributos_personagem_ficha_atributo"/>
        
        <!-- Constraints de validação -->
        <sql>
            ALTER TABLE "atributos_personagem" ADD CONSTRAINT check_atributos_range 
              CHECK (valor BETWEEN 1 AND 20);
            
            ALTER TABLE "atributos_personagem" ADD CONSTRAINT check_valor_temp_range 
              CHECK (valor_temp IS NULL OR valor_temp BETWEEN 1 AND 20);
        </sql>
        
        <!-- Rollback -->
        <rollback>
            DROP TABLE IF EXISTS proficiencias_personagem;
            DROP TABLE IF EXISTS acoes_personagem;
            DROP TABLE IF EXISTS deslocamento_personagem;
            DROP TABLE IF EXISTS sentidos_personagem;
            DROP TABLE IF EXISTS resistencias_personagem;
            DROP TABLE IF EXISTS atributos_personagem;
        </rollback>
    </changeSet>
</databaseChangeLog>
