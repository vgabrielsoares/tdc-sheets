<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Changeset 1: Índices para tabela users -->
    <changeSet id="001-create-user-indexes" author="tdc-sheets">
        <comment>Criação de índices para otimização de queries de usuário</comment>
        
        <!-- Índice para busca por email -->
        <createIndex tableName="users" indexName="idx_users_email">
            <column name="email"/>
        </createIndex>
        
        <!-- Índice para busca por username -->
        <createIndex tableName="users" indexName="idx_users_username">
            <column name="username"/>
        </createIndex>
        
        <!-- Índice para usuários ativos -->
        <createIndex tableName="users" indexName="idx_users_enabled">
            <column name="enabled"/>
        </createIndex>
        
        <!-- Índice para data de criação -->
        <createIndex tableName="users" indexName="idx_users_created_at">
            <column name="created_at"/>
        </createIndex>
        
        <!-- Índice para último login -->
        <createIndex tableName="users" indexName="idx_users_last_login">
            <column name="last_login"/>
        </createIndex>
        
        <rollback>
            <dropIndex tableName="users" indexName="idx_users_email"/>
            <dropIndex tableName="users" indexName="idx_users_username"/>
            <dropIndex tableName="users" indexName="idx_users_enabled"/>
            <dropIndex tableName="users" indexName="idx_users_created_at"/>
            <dropIndex tableName="users" indexName="idx_users_last_login"/>
        </rollback>
    </changeSet>

    <!-- Changeset 2: Índices para tabela ficha_personagem -->
    <changeSet id="002-create-ficha-indexes" author="tdc-sheets">
        <comment>Criação de índices para otimização de queries de fichas</comment>
        
        <!-- Índice para busca por usuário -->
        <createIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_user_id">
            <column name="user_id"/>
        </createIndex>
        
        <!-- Índice para busca por nome -->
        <createIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_nome">
            <column name="nome_personagem"/>
        </createIndex>
        
        <!-- Índice para fichas ativas -->
        <createIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_active">
            <column name="is_active"/>
        </createIndex>
        
        <!-- Índice para busca por origem -->
        <createIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_origem">
            <column name="origem_id"/>
        </createIndex>
        
        <!-- Índice para busca por linhagem -->
        <createIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_linhagem">
            <column name="linhagem_id"/>
        </createIndex>
        
        <!-- Índice para busca por experiência -->
        <createIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_experiencia">
            <column name="experiencia"/>
        </createIndex>
        
        <!-- Índice para data de criação -->
        <createIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_created_at">
            <column name="created_at"/>
        </createIndex>
        
        <!-- Índice composto para fichas ativas do usuário -->
        <createIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_user_active">
            <column name="user_id"/>
            <column name="is_active"/>
        </createIndex>
        
        <!-- Índice para soft delete -->
        <createIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_deleted_at">
            <column name="deleted_at"/>
        </createIndex>
        
        <rollback>
            <dropIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_user_id"/>
            <dropIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_nome"/>
            <dropIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_active"/>
            <dropIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_origem"/>
            <dropIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_linhagem"/>
            <dropIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_experiencia"/>
            <dropIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_created_at"/>
            <dropIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_user_active"/>
            <dropIndex tableName="ficha_personagem" indexName="idx_ficha_personagem_deleted_at"/>
        </rollback>
    </changeSet>

    <!-- Changeset 3: Índices para tabelas de relacionamento -->
    <changeSet id="003-create-relationship-indexes" author="tdc-sheets">
        <comment>Criação de índices para tabelas de relacionamento</comment>
        
        <!-- Índices para user_authorities -->
        <createIndex tableName="user_authorities" indexName="idx_user_authorities_user_id">
            <column name="user_id"/>
        </createIndex>
        
        <createIndex tableName="user_authorities" indexName="idx_user_authorities_authority_id">
            <column name="authority_id"/>
        </createIndex>
        
        <!-- Índices para arquetipos_personagem -->
        <createIndex tableName="arquetipos_personagem" indexName="idx_arquetipos_personagem_ficha_id">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <createIndex tableName="arquetipos_personagem" indexName="idx_arquetipos_personagem_arquetipo_id">
            <column name="arquetipo_id"/>
        </createIndex>
        
        <!-- Índices para defesa -->
        <createIndex tableName="defesa" indexName="idx_defesa_ficha_personagem_id">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <!-- Índices para pv_pp_personagem -->
        <createIndex tableName="pv_pp_personagem" indexName="idx_pv_pp_personagem_ficha_id">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <rollback>
            <dropIndex tableName="user_authorities" indexName="idx_user_authorities_user_id"/>
            <dropIndex tableName="user_authorities" indexName="idx_user_authorities_authority_id"/>
            <dropIndex tableName="arquetipos_personagem" indexName="idx_arquetipos_personagem_ficha_id"/>
            <dropIndex tableName="arquetipos_personagem" indexName="idx_arquetipos_personagem_arquetipo_id"/>
            <dropIndex tableName="defesa" indexName="idx_defesa_ficha_personagem_id"/>
            <dropIndex tableName="pv_pp_personagem" indexName="idx_pv_pp_personagem_ficha_id"/>
        </rollback>
    </changeSet>

    <!-- Changeset 4: Índices para busca textual -->
    <changeSet id="004-create-fulltext-indexes" author="tdc-sheets">
        <comment>Criação de índices para busca textual</comment>
        
        <!-- Índice GIN para busca textual no nome do personagem -->
        <sql>
            CREATE INDEX idx_ficha_personagem_nome_gin ON ficha_personagem USING gin(to_tsvector('portuguese', nome_personagem));
        </sql>
        
        <!-- Índice GIN para busca textual no background -->
        <sql>
            CREATE INDEX idx_ficha_personagem_background_gin ON ficha_personagem USING gin(to_tsvector('portuguese', background));
        </sql>
        
        <rollback>
            DROP INDEX IF EXISTS idx_ficha_personagem_nome_gin;
            DROP INDEX IF EXISTS idx_ficha_personagem_background_gin;
        </rollback>
    </changeSet>

    <!-- Changeset 5: Índices para tabelas de dados do jogo -->
    <changeSet id="005-create-game-data-indexes" author="tdc-sheets">
        <comment>Criação de índices para dados do jogo (arquetipos, habilidades, feitiços, etc.)</comment>
        
        <!-- Índices para arquetipos -->
        <createIndex tableName="arquetipo" indexName="idx_arquetipo_nome">
            <column name="nome"/>
        </createIndex>
        
        <!-- Índices para habilidades -->
        <createIndex tableName="habilidade" indexName="idx_habilidade_nome">
            <column name="nome"/>
        </createIndex>
        
        <createIndex tableName="habilidade" indexName="idx_habilidade_tipo">
            <column name="tipo"/>
        </createIndex>
        
        <createIndex tableName="habilidade" indexName="idx_habilidade_combate">
            <column name="combate"/>
        </createIndex>
        
        <!-- Índices para feitiços -->
        <createIndex tableName="feiticos" indexName="idx_feiticos_nome">
            <column name="nome"/>
        </createIndex>
        
        <createIndex tableName="feiticos" indexName="idx_feiticos_circulo">
            <column name="circulo"/>
        </createIndex>
        
        <createIndex tableName="feiticos" indexName="idx_feiticos_matriz">
            <column name="matriz"/>
        </createIndex>
        
        <createIndex tableName="feiticos" indexName="idx_feiticos_classe">
            <column name="classe_feitico"/>
        </createIndex>
        
        <!-- Índices para equipamentos -->
        <createIndex tableName="equipamentos" indexName="idx_equipamentos_nome">
            <column name="nome"/>
        </createIndex>
        
        <createIndex tableName="equipamentos" indexName="idx_equipamentos_tipo">
            <column name="tipo"/>
        </createIndex>
        
        <createIndex tableName="equipamentos" indexName="idx_equipamentos_raridade">
            <column name="raridade"/>
        </createIndex>
        
        <!-- Índices para origens -->
        <createIndex tableName="origem" indexName="idx_origem_nome">
            <column name="nome"/>
        </createIndex>
        
        <!-- Índices para linhagens -->
        <createIndex tableName="linhagem" indexName="idx_linhagem_nome">
            <column name="nome"/>
        </createIndex>
        
        <rollback>
            <dropIndex tableName="arquetipo" indexName="idx_arquetipo_nome"/>
            <dropIndex tableName="habilidade" indexName="idx_habilidade_nome"/>
            <dropIndex tableName="habilidade" indexName="idx_habilidade_tipo"/>
            <dropIndex tableName="habilidade" indexName="idx_habilidade_combate"/>
            <dropIndex tableName="feiticos" indexName="idx_feiticos_nome"/>
            <dropIndex tableName="feiticos" indexName="idx_feiticos_circulo"/>
            <dropIndex tableName="feiticos" indexName="idx_feiticos_matriz"/>
            <dropIndex tableName="feiticos" indexName="idx_feiticos_classe"/>
            <dropIndex tableName="equipamentos" indexName="idx_equipamentos_nome"/>
            <dropIndex tableName="equipamentos" indexName="idx_equipamentos_tipo"/>
            <dropIndex tableName="equipamentos" indexName="idx_equipamentos_raridade"/>
            <dropIndex tableName="origem" indexName="idx_origem_nome"/>
            <dropIndex tableName="linhagem" indexName="idx_linhagem_nome"/>
        </rollback>
    </changeSet>

    <!-- Changeset 6: Índices para relacionamentos personagem -->
    <changeSet id="006-create-character-relationship-indexes" author="tdc-sheets">
        <comment>Criação de índices para relacionamentos do personagem</comment>
        
        <!-- Índices para atributos do personagem -->
        <createIndex tableName="atributos_personagem" indexName="idx_atributos_personagem_ficha">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <createIndex tableName="atributos_personagem" indexName="idx_atributos_personagem_atributo">
            <column name="atributo"/>
        </createIndex>
        
        <createIndex tableName="atributos_personagem" indexName="idx_atributos_personagem_ativo">
            <column name="is_active"/>
        </createIndex>
        
        <!-- Índices para habilidades do personagem -->
        <createIndex tableName="habilidades_personagem" indexName="idx_habilidades_personagem_ficha">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <createIndex tableName="habilidades_personagem" indexName="idx_habilidades_personagem_habilidade">
            <column name="habilidade_id"/>
        </createIndex>
        
        <createIndex tableName="habilidades_personagem" indexName="idx_habilidades_personagem_grau">
            <column name="grau_habilidade"/>
        </createIndex>
        
        <createIndex tableName="habilidades_personagem" indexName="idx_habilidades_personagem_ativo">
            <column name="is_active"/>
        </createIndex>
        
        <!-- Índices para feitiços do personagem -->
        <createIndex tableName="feiticos_personagem" indexName="idx_feiticos_personagem_ficha">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <createIndex tableName="feiticos_personagem" indexName="idx_feiticos_personagem_feitico">
            <column name="feitico_id"/>
        </createIndex>
        
        <createIndex tableName="feiticos_personagem" indexName="idx_feiticos_personagem_ativo">
            <column name="is_active"/>
        </createIndex>
        
        <!-- Índices para inventário do personagem -->
        <createIndex tableName="inventario_personagem" indexName="idx_inventario_personagem_ficha">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <createIndex tableName="inventario_personagem" indexName="idx_inventario_personagem_equipamento">
            <column name="equipamento_id"/>
        </createIndex>
        
        <createIndex tableName="inventario_personagem" indexName="idx_inventario_personagem_equipado">
            <column name="equipado"/>
        </createIndex>
        
        <createIndex tableName="inventario_personagem" indexName="idx_inventario_personagem_ativo">
            <column name="is_active"/>
        </createIndex>
        
        <!-- Índices para arquetipos do personagem -->
        <createIndex tableName="arquetipos_personagem" indexName="idx_arquetipos_personagem_ficha">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <createIndex tableName="arquetipos_personagem" indexName="idx_arquetipos_personagem_arquetipo">
            <column name="arquetipo_id"/>
        </createIndex>
        
        <createIndex tableName="arquetipos_personagem" indexName="idx_arquetipos_personagem_ativo">
            <column name="is_active"/>
        </createIndex>
        
        <!-- Índices para compartilhamento de fichas -->
        <createIndex tableName="compartilhamento_ficha" indexName="idx_compartilhamento_ficha_ficha">
            <column name="ficha_personagem_id"/>
        </createIndex>
        
        <createIndex tableName="compartilhamento_ficha" indexName="idx_compartilhamento_ficha_user">
            <column name="user_id"/>
        </createIndex>
        
        <createIndex tableName="compartilhamento_ficha" indexName="idx_compartilhamento_ficha_token">
            <column name="link_token"/>
        </createIndex>
        
        <createIndex tableName="compartilhamento_ficha" indexName="idx_compartilhamento_ficha_ativo">
            <column name="ativo"/>
        </createIndex>
        
        <createIndex tableName="compartilhamento_ficha" indexName="idx_compartilhamento_ficha_is_active">
            <column name="is_active"/>
        </createIndex>
        
        <rollback>
            <dropIndex tableName="atributos_personagem" indexName="idx_atributos_personagem_ficha"/>
            <dropIndex tableName="atributos_personagem" indexName="idx_atributos_personagem_atributo"/>
            <dropIndex tableName="atributos_personagem" indexName="idx_atributos_personagem_ativo"/>
            <dropIndex tableName="habilidades_personagem" indexName="idx_habilidades_personagem_ficha"/>
            <dropIndex tableName="habilidades_personagem" indexName="idx_habilidades_personagem_habilidade"/>
            <dropIndex tableName="habilidades_personagem" indexName="idx_habilidades_personagem_grau"/>
            <dropIndex tableName="habilidades_personagem" indexName="idx_habilidades_personagem_ativo"/>
            <dropIndex tableName="feiticos_personagem" indexName="idx_feiticos_personagem_ficha"/>
            <dropIndex tableName="feiticos_personagem" indexName="idx_feiticos_personagem_feitico"/>
            <dropIndex tableName="feiticos_personagem" indexName="idx_feiticos_personagem_ativo"/>
            <dropIndex tableName="inventario_personagem" indexName="idx_inventario_personagem_ficha"/>
            <dropIndex tableName="inventario_personagem" indexName="idx_inventario_personagem_equipamento"/>
            <dropIndex tableName="inventario_personagem" indexName="idx_inventario_personagem_equipado"/>
            <dropIndex tableName="inventario_personagem" indexName="idx_inventario_personagem_ativo"/>
            <dropIndex tableName="arquetipos_personagem" indexName="idx_arquetipos_personagem_ficha"/>
            <dropIndex tableName="arquetipos_personagem" indexName="idx_arquetipos_personagem_arquetipo"/>
            <dropIndex tableName="arquetipos_personagem" indexName="idx_arquetipos_personagem_ativo"/>
            <dropIndex tableName="compartilhamento_ficha" indexName="idx_compartilhamento_ficha_ficha"/>
            <dropIndex tableName="compartilhamento_ficha" indexName="idx_compartilhamento_ficha_user"/>
            <dropIndex tableName="compartilhamento_ficha" indexName="idx_compartilhamento_ficha_token"/>
            <dropIndex tableName="compartilhamento_ficha" indexName="idx_compartilhamento_ficha_ativo"/>
            <dropIndex tableName="compartilhamento_ficha" indexName="idx_compartilhamento_ficha_is_active"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
