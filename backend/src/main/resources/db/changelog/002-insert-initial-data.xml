<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Changeset 1: Inserir dados iniciais de authorities via CSV -->
    <changeSet id="001-insert-authorities-csv" author="tdc-sheets">
        <comment>Inserção das authorities/roles padrão do sistema via CSV</comment>
        
        <loadData 
            encoding="UTF-8"
            file="db/data/authorities.csv"
            separator=";"
            tableName="authority">
            <column name="authority" type="STRING"/>
            <column name="descricao" type="STRING"/>
        </loadData>
        
        <rollback>
            DELETE FROM authority WHERE authority IN ('ROLE_ADMIN', 'ROLE_USER', 'ROLE_PLAYER', 'ROLE_GAME_MASTER');
        </rollback>
    </changeSet>

    <!-- Changeset 2: Inserir usuários padrão via CSV -->
    <changeSet id="002-insert-users-csv" author="tdc-sheets">
        <comment>Inserção dos usuários padrão do sistema via CSV</comment>
        
        <loadData 
            encoding="UTF-8"
            file="db/data/users.csv"
            separator=";"
            tableName="user">
            <column name="username" type="STRING"/>
            <column name="email" type="STRING"/>
            <column name="senha" type="STRING"/>
            <column name="nome_completo" type="STRING"/>
            <column name="ativo" type="BOOLEAN"/>
            <column name="primeiro_acesso" type="BOOLEAN"/>
            <column name="created_at" type="TIMESTAMP"/>
        </loadData>
        
        <rollback>
            DELETE FROM "user" WHERE username IN ('admin', 'teste', 'jogador1', 'mestre1');
        </rollback>
    </changeSet>

    <!-- Changeset 3: Associar authorities aos usuários -->
    <changeSet id="003-insert-user-authorities" author="tdc-sheets">
        <comment>Associação de authorities aos usuários</comment>
        
        <!-- Admin user - todas as authorities -->
        <sql>
            INSERT INTO user_authority (user_id, authority_id)
            SELECT u.id, a.id
            FROM "user" u, authority a
            WHERE u.username = 'admin' AND a.authority = 'ROLE_ADMIN';
        </sql>
        
        <!-- Usuário de teste - role USER -->
        <sql>
            INSERT INTO user_authority (user_id, authority_id)
            SELECT u.id, a.id
            FROM "user" u, authority a
            WHERE u.username = 'teste' AND a.authority = 'ROLE_USER';
        </sql>
        
        <!-- Jogador - role PLAYER -->
        <sql>
            INSERT INTO user_authority (user_id, authority_id)
            SELECT u.id, a.id
            FROM "user" u, authority a
            WHERE u.username = 'jogador1' AND a.authority = 'ROLE_PLAYER';
        </sql>
        
        <!-- Mestre - role GAME_MASTER -->
        <sql>
            INSERT INTO user_authority (user_id, authority_id)
            SELECT u.id, a.id
            FROM "user" u, authority a
            WHERE u.username = 'mestre1' AND a.authority = 'ROLE_GAME_MASTER';
        </sql>
        
        <rollback>
            DELETE FROM user_authority WHERE user_id IN (
                SELECT id FROM "user" WHERE username IN ('admin', 'teste', 'jogador1', 'mestre1')
            );
        </rollback>
    </changeSet>

    <!-- Changeset 3: Inserir dados básicos de arquetipos -->
    <changeSet id="003-insert-arquetipos" author="tdc-sheets">
        <comment>Inserção dos arquetipos básicos do sistema TDC</comment>
        
        <insert tableName="arquetipo">
            <column name="nome" value="ACADEMICO"/>
            <column name="pv_inicial" value="15"/>
            <column name="pp_inicial" value="4"/>
            <column name="pv_nivel" value="3"/>
            <column name="pp_nivel" value="2"/>
            <column name="defesa_5" value="1"/>
            <column name="defesa_10" value="2"/>
            <column name="defesa_15" value="3"/>
        </insert>
        
        <insert tableName="arquetipo">
            <column name="nome" value="ACOLITO"/>
            <column name="pv_inicial" value="18"/>
            <column name="pp_inicial" value="3"/>
            <column name="pv_nivel" value="4"/>
            <column name="pp_nivel" value="1"/>
            <column name="defesa_5" value="2"/>
            <column name="defesa_10" value="3"/>
            <column name="defesa_15" value="4"/>
        </insert>
        
        <insert tableName="arquetipo">
            <column name="nome" value="COMBATENTE"/>
            <column name="pv_inicial" value="21"/>
            <column name="pp_inicial" value="2"/>
            <column name="pv_nivel" value="5"/>
            <column name="pp_nivel" value="1"/>
            <column name="defesa_5" value="3"/>
            <column name="defesa_10" value="4"/>
            <column name="defesa_15" value="5"/>
        </insert>
        
        <insert tableName="arquetipo">
            <column name="nome" value="FEITICEIRO"/>
            <column name="pv_inicial" value="12"/>
            <column name="pp_inicial" value="5"/>
            <column name="pv_nivel" value="2"/>
            <column name="pp_nivel" value="3"/>
            <column name="defesa_5" value="0"/>
            <column name="defesa_10" value="1"/>
            <column name="defesa_15" value="2"/>
        </insert>
        
        <insert tableName="arquetipo">
            <column name="nome" value="LADINO"/>
            <column name="pv_inicial" value="16"/>
            <column name="pp_inicial" value="3"/>
            <column name="pv_nivel" value="4"/>
            <column name="pp_nivel" value="1"/>
            <column name="defesa_5" value="2"/>
            <column name="defesa_10" value="3"/>
            <column name="defesa_15" value="4"/>
        </insert>
        
        <insert tableName="arquetipo">
            <column name="nome" value="NATURAL"/>
            <column name="pv_inicial" value="19"/>
            <column name="pp_inicial" value="3"/>
            <column name="pv_nivel" value="4"/>
            <column name="pp_nivel" value="2"/>
            <column name="defesa_5" value="2"/>
            <column name="defesa_10" value="3"/>
            <column name="defesa_15" value="4"/>
        </insert>
        
        <rollback>
            DELETE FROM arquetipo WHERE nome IN ('ACADEMICO', 'ACOLITO', 'COMBATENTE', 'FEITICEIRO', 'LADINO', 'NATURAL');
        </rollback>
    </changeSet>

</databaseChangeLog>
