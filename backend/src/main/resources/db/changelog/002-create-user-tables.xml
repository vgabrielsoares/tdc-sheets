<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Changeset: Criação das tabelas do sistema de usuários -->
    <changeSet id="002-create-user-tables" author="tdc-sheets">
        <comment>Criação das tabelas para usuários e autenticação</comment>
        
        <!-- Tabela de usuários -->
        <createTable tableName="user">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="nome_completo" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="username" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="email" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="senha" type="VARCHAR(60)">
                <constraints nullable="false"/>
            </column>
            <column name="ativo" type="BOOLEAN" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="primeiro_acesso" type="BOOLEAN" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="data_nascimento" type="DATE"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="created_by_user_id" type="BIGINT"/>
            <column name="updated_by_user_id" type="BIGINT"/>
            <column name="created_ip_address" type="VARCHAR(45)"/>
            <column name="updated_ip_address" type="VARCHAR(45)"/>
            <column name="deleted_at" type="TIMESTAMP"/>
            <column name="deleted_by_user_id" type="BIGINT"/>
            <column name="is_active" type="BOOLEAN" defaultValue="true">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de autoridades/roles -->
        <createTable tableName="authorities">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="authority" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="descricao" type="VARCHAR(200)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de relacionamento usuário-autoridade -->
        <createTable tableName="user_authority">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="authority_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Índices únicos -->
        <createIndex tableName="user_authority" indexName="idx_user_authority_unique">
            <column name="user_id"/>
            <column name="authority_id"/>
        </createIndex>
        
        <!-- Índices para performance -->
        <createIndex tableName="user" indexName="idx_user_username">
            <column name="username"/>
        </createIndex>
        
        <createIndex tableName="user" indexName="idx_user_email">
            <column name="email"/>
        </createIndex>
        
        <createIndex tableName="user" indexName="idx_user_active">
            <column name="is_active"/>
        </createIndex>
        
        <!-- Rollback -->
        <rollback>
            DROP TABLE IF EXISTS user_authority;
            DROP TABLE IF EXISTS authorities;
            DROP TABLE IF EXISTS "user";
        </rollback>
    </changeSet>
</databaseChangeLog>
