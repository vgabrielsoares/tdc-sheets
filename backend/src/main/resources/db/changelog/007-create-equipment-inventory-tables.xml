<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Changeset: Criação das tabelas de equipamentos e inventário -->
    <changeSet id="007-create-equipment-inventory-tables" author="tdc-sheets">
        <comment>Criação das tabelas para equipamentos, ataques e inventário</comment>
        
        <!-- Tabela de equipamentos -->
        <createTable tableName="equipamentos">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="nome" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="tipo" type="tipos_equipamentos">
                <constraints nullable="false"/>
            </column>
            <column name="subtipo" type="VARCHAR(50)"/>
            <column name="peso" type="DECIMAL(6,2)">
                <constraints nullable="false"/>
            </column>
            <column name="valor" type="DECIMAL(10,2)"/>
            <column name="moeda" type="VARCHAR(3)" defaultValue="PC"/>
            <column name="descricao" type="TEXT"/>
            <column name="raridade" type="raridades" defaultValue="COMUM"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValue="true">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de inventário do personagem -->
        <createTable tableName="inventario_personagem">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ficha_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="equipamento_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="quantidade" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="equipado" type="BOOLEAN" defaultValue="false"/>
            <column name="local_equipado" type="VARCHAR(50)"/>
            <column name="notas" type="VARCHAR(255)"/>
            <column name="carga_personagem_id" type="BIGINT"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de ataques do personagem -->
        <createTable tableName="ataques_personagem">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ficha_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="nome_ataque" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="bonus_ataque" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="alcance" type="VARCHAR(50)"/>
            <column name="tipo_acao" type="tempo_acoes"/>
            <column name="notas" type="VARCHAR(255)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de dano do ataque -->
        <createTable tableName="dano_ataque">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ataque_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="dado_dano" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="qtd_dados" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="bonus_dano" type="INTEGER" defaultValue="0"/>
            <column name="tipo_dano" type="tipos_dano">
                <constraints nullable="false"/>
            </column>
            <column name="critico" type="VARCHAR(8)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de carga do personagem -->
        <createTable tableName="carga_personagem">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ficha_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="carga_atual" type="DECIMAL(8,2)" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="capacidade_carga" type="DECIMAL(8,2)">
                <constraints nullable="false"/>
            </column>
            <column name="bonus_capacidade_carga" type="INTEGER" defaultValue="0"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de cunhagem do personagem -->
        <createTable tableName="cunhagem_personagem">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="carga_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="po" type="INTEGER" defaultValue="0"/>
            <column name="pp" type="INTEGER" defaultValue="0"/>
            <column name="pc" type="INTEGER" defaultValue="0"/>
            <column name="pe" type="INTEGER" defaultValue="0"/>
            <column name="pl" type="INTEGER" defaultValue="0"/>
            <column name="pp_banco" type="INTEGER" defaultValue="0"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de particularidades -->
        <createTable tableName="particularidade">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="nome" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="descricao" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="pontos" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de particularidades do personagem -->
        <createTable tableName="particularidades_personagem">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ficha_personagem_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="particularidade_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="observacoes" type="VARCHAR(255)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Tabela de relacionamento entre feitiços e habilidades do personagem -->
        <createTable tableName="feiticos_personagem_habilidades_personagem">
            <column name="feiticos_personagem_habilidade" type="BIGINT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="habilidades_personagem_id" type="BIGINT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Índices para performance -->
        <createIndex tableName="equipamentos" indexName="idx_equipamentos_tipo">
            <column name="tipo"/>
        </createIndex>
        
        <!-- Constraints de validação -->
        <sql>
            ALTER TABLE "equipamentos" ADD CONSTRAINT check_peso_positivo 
              CHECK (peso >= 0);
              
            ALTER TABLE "carga_personagem" ADD CONSTRAINT check_carga_valida 
              CHECK (carga_atual >= 0 AND capacidade_carga >= 0);
        </sql>
        
        <!-- Rollback -->
        <rollback>
            DROP TABLE IF EXISTS feiticos_personagem_habilidades_personagem;
            DROP TABLE IF EXISTS particularidades_personagem;
            DROP TABLE IF EXISTS particularidade;
            DROP TABLE IF EXISTS cunhagem_personagem;
            DROP TABLE IF EXISTS carga_personagem;
            DROP TABLE IF EXISTS dano_ataque;
            DROP TABLE IF EXISTS ataques_personagem;
            DROP TABLE IF EXISTS inventario_personagem;
            DROP TABLE IF EXISTS equipamentos;
        </rollback>
    </changeSet>
</databaseChangeLog>
